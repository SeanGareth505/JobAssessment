<mat-card class="page-card">
  <mat-card-header>
    <mat-card-title>Orders</mat-card-title>
    <mat-card-subtitle>Filter by customer and status; sort and paginate</mat-card-subtitle>
  </mat-card-header>

  <mat-card-content>
    <div class="toolbar-row">
      <mat-form-field appearance="outline">
        <mat-label>Customer</mat-label>
        <mat-select [ngModel]="customerId()" (ngModelChange)="customerId.set($event)">
          <mat-option value="">All</mat-option>
          @for (c of customers(); track c.id) {
            <mat-option [value]="c.id">{{ c.name }} ({{ c.countryCode }})</mat-option>
          }
        </mat-select>
      </mat-form-field>
      <mat-form-field appearance="outline">
        <mat-label>Status</mat-label>
        <mat-select [ngModel]="status()" (ngModelChange)="status.set($event)">
          <mat-option value="">All</mat-option>
          <mat-option value="0">Pending</mat-option>
          <mat-option value="1">Paid</mat-option>
          <mat-option value="2">Fulfilled</mat-option>
          <mat-option value="3">Cancelled</mat-option>
        </mat-select>
      </mat-form-field>
      <mat-form-field appearance="outline">
        <mat-label>Sort</mat-label>
        <mat-select [ngModel]="sort()" (ngModelChange)="sort.set($event)">
          <mat-option value="createdAt">Created (newest)</mat-option>
          <mat-option value="-createdAt">Created (oldest)</mat-option>
          <mat-option value="totalAmount">Total (low first)</mat-option>
          <mat-option value="-totalAmount">Total (high first)</mat-option>
        </mat-select>
      </mat-form-field>
      <div class="toolbar-actions">
        <button mat-button (click)="onFilter()">Apply</button>
        @if (auth.hasWriteRole()) {
          <button mat-raised-button color="primary" (click)="openNewOrderModal()">New Order</button>
        }
      </div>
    </div>

    @if (error()) {
      <p class="error-msg">{{ error() }}</p>
    }
    @if (loading()) {
      <mat-spinner diameter="32"></mat-spinner>
    } @else {
      <div class="table-wrapper">
        <table mat-table [dataSource]="items()" class="data-table mat-elevation-z0">
          <ng-container matColumnDef="createdAt">
            <th mat-header-cell *matHeaderCellDef>Created</th>
            <td mat-cell *matCellDef="let row">{{ row.createdAt | date: 'short' }}</td>
          </ng-container>
          <ng-container matColumnDef="customerName">
            <th mat-header-cell *matHeaderCellDef>Customer</th>
            <td mat-cell *matCellDef="let row">{{ row.customerName ?? '-' }}</td>
          </ng-container>
          <ng-container matColumnDef="status">
            <th mat-header-cell *matHeaderCellDef>Status</th>
            <td mat-cell *matCellDef="let row">{{ statusLabel(row.status) }}</td>
          </ng-container>
          <ng-container matColumnDef="totalAmount">
            <th mat-header-cell *matHeaderCellDef>Total</th>
            <td mat-cell *matCellDef="let row">
              {{ row.totalAmount | number: '1.2-2' }} {{ row.currencyCode }}
            </td>
          </ng-container>
          <ng-container matColumnDef="currencyCode">
            <th mat-header-cell *matHeaderCellDef>Currency</th>
            <td mat-cell *matCellDef="let row">{{ row.currencyCode }}</td>
          </ng-container>
          <ng-container matColumnDef="actions">
            <th mat-header-cell *matHeaderCellDef>Actions</th>
            <td mat-cell *matCellDef="let row">
              <div class="actions-cell">
                <button
                  mat-icon-button
                  [matMenuTriggerFor]="orderActionsMenu"
                  (menuOpened)="selectedOrderForMenu.set(row)"
                  [attr.aria-label]="'Actions for order ' + row.id"
                  class="menu-btn"
                >
                  <mat-icon>more_vert</mat-icon>
                </button>
              </div>
            </td>
          </ng-container>
          <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
          <tr mat-row *matRowDef="let row; columns: displayedColumns"></tr>
          <tr class="mat-row empty-state-row" *matNoDataRow>
            <td class="mat-cell" colspan="6">No orders found.</td>
          </tr>
        </table>

        <mat-menu #orderActionsMenu="matMenu">
          @if (selectedOrderForMenu(); as order) {
            <a mat-menu-item [routerLink]="['/orders', order.id]">
              <mat-icon>visibility</mat-icon>
              <span>View</span>
            </a>
            @if (auth.hasWriteRole()) {
              <mat-divider></mat-divider>
              @if (hasStatusActions(order)) {
                <button mat-menu-item [matMenuTriggerFor]="changeStatusMenu">
                  <mat-icon>swap_horiz</mat-icon>
                  <span>Change status</span>
                  <mat-icon class="submenu-icon">chevron_right</mat-icon>
                </button>
                <mat-menu #changeStatusMenu="matMenu">
                  @if (canTransitionToPaid(order)) {
                    <button
                      mat-menu-item
                      [disabled]="updatingOrderId() === order.id"
                      (click)="updateStatus(order, 1)"
                    >
                      <mat-icon>payments</mat-icon>
                      <span>Mark Paid</span>
                    </button>
                  }
                  @if (canTransitionToFulfilled(order)) {
                    <button
                      mat-menu-item
                      [disabled]="updatingOrderId() === order.id"
                      (click)="updateStatus(order, 2)"
                    >
                      <mat-icon>check_circle</mat-icon>
                      <span>Mark Fulfilled</span>
                    </button>
                  }
                  @if (canTransitionToCancelled(order)) {
                    <button
                      mat-menu-item
                      [disabled]="updatingOrderId() === order.id"
                      (click)="updateStatus(order, 3)"
                    >
                      <mat-icon>cancel</mat-icon>
                      <span>Cancel order</span>
                    </button>
                  }
                </mat-menu>
              }
              @if (canEditOrder(order)) {
                <mat-divider></mat-divider>
                <button mat-menu-item (click)="openEditOrderDialog(order)">
                  <mat-icon>edit</mat-icon>
                  <span>Edit order</span>
                </button>
              }
            }
          }
        </mat-menu>

        <mat-paginator
          [length]="totalCount()"
          [pageSize]="pageSize()"
          [pageIndex]="page() - 1"
          [pageSizeOptions]="[10, 20, 50, 100]"
          (page)="onPage($event)"
          showFirstLastButtons
        >
        </mat-paginator>
      </div>
    }
  </mat-card-content>
</mat-card>
